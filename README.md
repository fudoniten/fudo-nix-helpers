# fudo-nix-helpers

This repository contains a collection of reusable Nix helpers used across Fudo's
Clojure and Ruby projects.  The flake defines functions for packaging Clojure
libraries, building command line applications, creating container images and
orchestrating dependency injection tooling that smooths over some rough edges of
`tools.deps`-based projects.

## Repository layout

- `flake.nix` – top-level entry point exposing helper functions as flake
  packages and library utilities.
- `clojure-lib.nix` / `clojure-bin.nix` – high-level wrappers around
  [`clj-nix`](https://github.com/jlesquembre/clj-nix) to build libraries and
  binaries.
- `lib/` – shared source used by the helpers, such as the custom build script
  (`lib/build.clj`) and the dependency injectors used during packaging.

## Getting started

The flake exports a few key helpers.  Assuming you have `nix` installed, you can
open a development shell with

```bash
nix develop
```

From there, the helpers are available as regular derivations.  For example, to
build a Clojure library project you can use `mkClojureLib`:

```nix
mkClojureLib {
  name = "example";
  src = ./.;
  version = "1.0.0";
}
```

The companion `mkClojureBin` function produces a runnable CLI application using
an uberjar generated by `clj-nix`.

## Dependency injection tooling

The `lib/injector` and `lib/build-injector` directories contain small command
line tools used to modify `deps.edn` files at build time.  They inject
`:local/root` overrides (for replacing dependencies with local paths) and build
namespace/dependency configuration respectively.

Both tools can be run through the flake outputs:

```bash
nix run .#cljInject -- --deps-file path/to/deps.edn my.library ./local/lib
nix run .#cljBuildInject -- --deps-file path/to/deps.edn --build-namespace build.ns my.library/tools 1.2.3
```

## Updating locked dependencies

The `updateClojureDeps` helper rewrites a project's `deps-lock.json` using the
same injection logic as the build helpers.  Run it from the project directory:

```bash
nix run .#updateClojureDeps
```

Additional documentation for the injectors lives alongside their source under
`lib/injector/README.md` and `lib/build-injector/README.md`.
